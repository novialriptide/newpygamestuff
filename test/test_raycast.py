import unittest

from geometry import raycast, Circle, Line
from pygame import Rect


class RaycastTest(unittest.TestCase):
    def test_raycast_endpoint(self):
        with self.assertRaises(TypeError):
            for x in ["1", 1, (0, 0, 0), [0, 0, 0], []]:
                raycast(x, (0, 0), [])

            for x in ["1", 1, (0, 0, 0), [0, 0, 0]]:
                raycast((0, 0), x, [])

            for x in ["1", 1, (0, 0, 0), [0, 0, 0]]:
                raycast((0, 0), (0, 0), x)

        with self.assertRaises(TypeError):
            raycast()
            raycast(1, 2, 3, 4, 5)

        startendpos = [
            ((0, 0), (10, 10), (0.5, 0.5)),
            ((0, 0), (-1, -1), (-0.7071067811865476, -0.7071067811865476)),
        ]

        collisions = [
            Line(0, 10, 10, 0),
            Line(0, 1, 1, 0),
            Line(-1, -2, -3, -4),
            Circle((5, 5), 1),
            Circle((0, 0), 1),
        ]

        for x in startendpos:
            result = raycast(x[0], x[1], collisions)
            self.assertEqual(result, x[2])

    def test_raycast_angle(self):
        with self.assertRaises(TypeError):
            for x in ["1", 1, (0, 0, 0), [0, 0, 0], []]:
                raycast(x, 4, 5, [])

            for x in [(0, 0), (0, 0, 0), [0, 0, 0]]:
                raycast((0, 0), x, 5, [])

            for x in [(0, 0), (0, 0, 0), [0, 0, 0]]:
                raycast((0, 0), 4, x, [])

            for x in ["1", 1, (0, 0, 0), [0, 0, 0]]:
                raycast((0, 0), 4, 5, x)

        colliders = [
            Line(485.0, 724.0, 596.0, 564.0),
            Line(331.0, 74.0, 422.0, 39.0),
            Line(337.0, 439.0, 537.0, 787.0),
            Line(577.0, 667.0, 463.0, 363.0),
            Line(443.0, 91.0, 592.0, 75.0),
            Line(506.0, 495.0, 798.0, 16.0),
            Line(130.0, 426.0, 710.0, 666.0),
            Line(632.0, 474.0, 121.0, 179.0),
            Line(361.0, 188.0, 58.0, 388.0),
            Line(469.0, 233.0, 144.0, 346.0),
            Line(725.0, 109.0, 154.0, 617.0),
            Line(244.0, 693.0, 50.0, 350.0),
            Line(377.0, 36.0, 363.0, 660.0),
            Line(173.0, 549.0, 596.0, 105.0),
            Line(329.0, 220.0, 752.0, 556.0),
            Circle((204.0, 632.0), 37.0),
            Circle((255.0, 115.0), 31.0),
            Circle((59.0, 255.0), 7.0),
            Circle((297.0, 147.0), 33.0),
            Circle((243.0, 441.0), 23.0),
            Circle((218.0, 462.0), 44.0),
            Circle((193.0, 101.0), 29.0),
            Circle((78.0, 329.0), 33.0),
            Circle((673.0, 297.0), 16.0),
            Circle((61.0, 587.0), 12.0),
            Circle((168.0, 119.0), 21.0),
            Circle((709.0, 591.0), 15.0),
            Circle((104.0, 470.0), 48.0),
            Circle((162.0, 561.0), 19.0),
            Circle((704.0, 256.0), 28.0),
            Rect(707, 423, 24, 43),
            Rect(212, 254, 42, 48),
            Rect(11, 173, 21, 16),
            Rect(134, 513, 26, 36),
            Rect(514, 52, 14, 46),
            Rect(353, 245, 11, 8),
            Rect(551, 14, 21, 32),
            Rect(116, 306, 13, 37),
            Rect(595, 157, 38, 47),
            Rect(348, 189, 38, 46),
            Rect(153, 642, 33, 33),
            Rect(710, 252, 35, 37),
            Rect(256, 505, 5, 43),
            Rect(524, 692, 16, 17),
            Rect(682, 17, 33, 5),
        ]
        origin_pos = (348, 201)
        colliders = [
            Line(595.0, 745.0, 441.0, 175.0),
            Line(694.0, 724.0, 778.0, 765.0),
            Line(368.0, 19.0, 30.0, 686.0),
            Line(664.0, 720.0, 24.0, 771.0),
            Line(333.0, 691.0, 694.0, 545.0),
            Line(262.0, 769.0, 489.0, 588.0),
            Line(560.0, 371.0, 404.0, 695.0),
            Line(684.0, 174.0, 167.0, 484.0),
            Line(113.0, 415.0, 297.0, 763.0),
            Line(592.0, 763.0, 392.0, 661.0),
            Line(7.0, 277.0, 762.0, 208.0),
            Line(361.0, 504.0, 27.0, 726.0),
            Line(214.0, 339.0, 119.0, 309.0),
            Line(696.0, 229.0, 134.0, 217.0),
            Line(415.0, 569.0, 169.0, 435.0),
            Circle((229.0, 151.0), 31.0),
            Circle((216.0, 413.0), 46.0),
            Circle((410.0, 339.0), 15.0),
            Circle((258.0, 452.0), 46.0),
            Circle((564.0, 566.0), 45.0),
            Circle((265.0, 531.0), 26.0),
            Circle((709.0, 157.0), 49.0),
            Circle((658.0, 66.0), 45.0),
            Circle((38.0, 432.0), 32.0),
            Circle((309.0, 52.0), 6.0),
            Circle((121.0, 158.0), 32.0),
            Circle((362.0, 414.0), 34.0),
            Circle((643.0, 35.0), 30.0),
            Circle((144.0, 466.0), 43.0),
            Circle((178.0, 312.0), 28.0),
            Rect(663, 526, 36, 27),
            Rect(739, 446, 27, 39),
            Rect(14, 385, 30, 30),
            Rect(208, 33, 18, 22),
            Rect(207, 425, 21, 22),
            Rect(536, 225, 11, 48),
            Rect(751, 464, 11, 47),
            Rect(675, 444, 17, 5),
            Rect(683, 61, 34, 16),
            Rect(719, 37, 27, 33),
            Rect(232, 468, 12, 45),
            Rect(630, 42, 32, 11),
            Rect(321, 761, 29, 33),
            Rect(315, 740, 9, 13),
            Rect(578, 308, 48, 30),
        ]
        origin_pos = (230, 380)
        results = [
            (raycast(origin_pos, 0.0, 150, colliders), (185.06446776611693, 380.0)),
            (raycast(origin_pos, 1.0, 150, colliders), (185.45845091955988, 379.2225243687975)),
            (raycast(origin_pos, 2.5, 150, colliders), (186.05527403483222, 378.0813318285046)),
            (raycast(origin_pos, 3.5, 150, colliders), (186.91186717496282, 377.36461689902865)),
            (raycast(origin_pos, 10.5, 150, colliders), (193.02673177905652, 373.1474097799329)),
            (raycast(origin_pos, 12.999999999999998, 150, colliders), (195.20737770890491, 371.96749022713993)),
            (raycast(origin_pos, 14.0, 150, colliders), (196.07184286282046, 371.54076034083744)),
            (raycast(origin_pos, 17.0, 150, colliders), (198.6249120866818, 370.40767299143585)),
            (raycast(origin_pos, 18.0, 150, colliders), (199.4593375625366, 370.07673723806766)),
            (raycast(origin_pos, 18.5, 150, colliders), (199.87295023216626, 369.9196301572768)),
            (raycast(origin_pos, 20.5, 150, colliders), (201.50115681155856, 369.34471914880186)),
            (raycast(origin_pos, 21.5, 150, colliders), (202.2982908553389, 369.08800657547977)),
            (raycast(origin_pos, 27.0, 150, colliders), (206.45218140496422, 368.0017871457511)),
            (raycast(origin_pos, 27.500000000000004, 150, colliders), (206.80903177552315, 367.9275460719448)),
            (raycast(origin_pos, 30.0, 150, colliders), (208.53848457402273, 367.6091882915947)),
            (raycast(origin_pos, 30.5, 150, colliders), (208.87329208254047, 367.5554179878479)),
            (raycast(origin_pos, 33.5, 150, colliders), (210.8039463315033, 367.2944092448845)),
            (raycast(origin_pos, 34.0, 150, colliders), (211.11271118525806, 367.26036283439385)),
            (raycast(origin_pos, 39.5, 150, colliders), (214.2692510057655, 367.0325712278905)),
            (raycast(origin_pos, 40.5, 150, colliders), (214.79736567878564, 367.0157236580868)),
            (raycast(origin_pos, 41.0, 150, colliders), (215.05634646853596, 367.00968017057767)),
            (raycast(origin_pos, 43.0, 150, colliders), (216.0592476862544, 367.0000381553237)),
            (raycast(origin_pos, 46.50000000000001, 150, colliders), (217.69303681566683, 367.0311667937852)),
            (raycast(origin_pos, 48.0, 150, colliders), (218.34877503974727, 367.06000374605304)),
            (raycast(origin_pos, 49.50000000000001, 150, colliders), (218.9794482445426, 367.09659175880194)),
            (raycast(origin_pos, 50.0, 150, colliders), (219.18429691534735, 367.11034699243294)),
            (raycast(origin_pos, 53.0, 150, colliders), (220.35984115783012, 367.20707712890027)),
            (raycast(origin_pos, 53.5, 150, colliders), (220.54722242197616, 367.22530428014755)),
            (raycast(origin_pos, 55.5, 150, colliders), (221.2738109267788, 367.3033161125603)),
            (raycast(origin_pos, 57.0, 150, colliders), (221.795760099513, 367.3665784225104)),
            (raycast(origin_pos, 58.00000000000001, 150, colliders), (222.1333475258213, 367.4107244176056)),
            (raycast(origin_pos, 59.5, 150, colliders), (222.62489523945854, 367.47955664686253)),
            (raycast(origin_pos, 62.5, 150, colliders), (223.55806897517894, 367.62516563813773)),
            (raycast(origin_pos, 62.99999999999999, 150, colliders), (223.7075200469088, 367.65031273838264)),
            (raycast(origin_pos, 64.0, 150, colliders), (224.00150315647085, 367.7012588780109)),
            (raycast(origin_pos, 67.0, 150, colliders), (224.84629526001112, 367.8586324955401)),
            (raycast(origin_pos, 67.5, 150, colliders), (224.98198283222922, 367.8854348973467)),
            (raycast(origin_pos, 73.0, 150, colliders), (226.38885833693826, 368.1884878356574)),
            (raycast(origin_pos, 76.0, 150, colliders), (227.09749829497713, 368.35870150193904)),
            (raycast(origin_pos, 80.0, 150, colliders), (227.98803173680565, 368.589560967298)),
            (raycast(origin_pos, 81.5, 150, colliders), (228.30778291703604, 368.6771111087385)),
            (raycast(origin_pos, 82.0, 150, colliders), (228.4127885372404, 368.70640361485925)),
            (raycast(origin_pos, 85.0, 150, colliders), (229.02741147082233, 368.8832622424336)),
            (raycast(origin_pos, 88.0, 150, colliders), (229.6180361273469, 369.0619857977824)),
            (raycast(origin_pos, 88.5, 150, colliders), (229.71436283799272, 369.0919568649674)),
            (raycast(origin_pos, 90.0, 150, colliders), (230.0, 369.1821953995867)),
            (raycast(origin_pos, 92.49999999999999, 150, colliders), (230.46569960510342, 369.33372542871433)),
            (raycast(origin_pos, 93.00000000000001, 150, colliders), (230.55739812928488, 369.3642101056313)),
            (raycast(origin_pos, 96.0, 150, colliders), (231.0984998770613, 369.54847181671994)),
            (raycast(origin_pos, 101.0, 150, colliders), (231.9707368875113, 369.861437630933)),
            (raycast(origin_pos, 102.5, 150, colliders), (232.22648309548075, 369.95698376795514)),
            (raycast(origin_pos, 107.0, 150, colliders), (232.98115286524623, 370.2490883446079)),
            (raycast(origin_pos, 108.0, 150, colliders), (233.14676781985838, 370.315244485509)),
            (raycast(origin_pos, 111.0, 150, colliders), (233.64025538572346, 370.51681050195907)),
            (raycast(origin_pos, 117.0, 150, colliders), (234.61822683154577, 370.9362195036025)),
            (raycast(origin_pos, 120.0, 150, colliders), (235.1062886042344, 371.15564869935605)),
            (raycast(origin_pos, 122.0, 150, colliders), (235.43252054564022, 371.306149791087)),
            (raycast(origin_pos, 124.5, 150, colliders), (235.8421964969304, 371.49955134968775)),
            (raycast(origin_pos, 125.99999999999999, 150, colliders), (236.08940455532962, 371.6186536636095)),
            (raycast(origin_pos, 134.5, 150, colliders), (237.52215737836985, 372.345397040671)),
            (raycast(origin_pos, 135.0, 150, colliders), (237.60868046060455, 372.39131953939545)),
            (raycast(origin_pos, 136.0, 150, colliders), (237.78265720642796, 372.48437529758115)),
            (raycast(origin_pos, 141.5, 150, colliders), (238.7649480022927, 373.02804555125044)),
            (raycast(origin_pos, 142.5, 150, colliders), (238.94882183309045, 373.13332749685435)),
            (raycast(origin_pos, 144.0, 150, colliders), (239.22809563334525, 373.29539606987413)),
            (raycast(origin_pos, 144.5, 150, colliders), (239.3221540568338, 373.3505721333925)),
            (raycast(origin_pos, 147.0, 150, colliders), (239.8002045860582, 373.6356727269248)),
            (raycast(origin_pos, 150.0, 150, colliders), (240.3924696784264, 373.9999048336155)),
            (raycast(origin_pos, 156.0, 150, colliders), (241.64809012941623, 374.81393614532465)),
            (raycast(origin_pos, 158.5, 150, colliders), (242.20350972051358, 375.19290968182094)),
            (raycast(origin_pos, 159.5, 150, colliders), (242.43159707873608, 375.3520163107325)),
            (raycast(origin_pos, 169.0, 150, colliders), (244.79179707937735, 377.12476591100824)),
            (raycast(origin_pos, 169.5, 150, colliders), (244.92674896306795, 377.2334906032522)),
            (raycast(origin_pos, 170.0, 150, colliders), (245.06286910637564, 377.34400976966594)),
            (raycast(origin_pos, 175.0, 150, colliders), (246.49091242019054, 378.55723211203446)),
            (raycast(origin_pos, 176.0, 150, colliders), (246.79163890644796, 378.8258142239655)),
            (raycast(origin_pos, 176.5, 150, colliders), (246.94394643280287, 378.9636638404803)),
            (raycast(origin_pos, 180.5, 150, colliders), (248.20967294896045, 380.15891340833855)),
            (raycast(origin_pos, 181.0, 150, colliders), (248.37382299188704, 380.32071627330293)),
            (raycast(origin_pos, 192.0, 150, colliders), (252.29476798440172, 384.7388992259953)),
            (raycast(origin_pos, 192.5, 150, colliders), (252.48489422501868, 384.9847810397777)),
            (raycast(origin_pos, 197.00000000000003, 150, colliders), (254.22192771208228, 387.40538646565733)),
            (raycast(origin_pos, 198.00000000000003, 150, colliders), (254.61133784186575, 387.99670841546447)),
            (raycast(origin_pos, 199.5, 150, colliders), (255.19504451782035, 388.92203319949795)),
            (raycast(origin_pos, 203.0, 150, colliders), (256.5419573160738, 391.2663924535836)),
            (raycast(origin_pos, 209.50000000000003, 150, colliders), (258.8760230875824, 396.3372678052757)),
            (raycast(origin_pos, 210.5, 150, colliders), (259.20182356961084, 397.20118864407146)),
            (raycast(origin_pos, 212.5, 150, colliders), (259.81621423438907, 398.99502337859434)),
            (raycast(origin_pos, 213.0, 150, colliders), (259.9612125020481, 399.45703890023424)),
            (raycast(origin_pos, 218.99999999999997, 150, colliders), (261.368056339842, 405.40135117636544)),
            (raycast(origin_pos, 226.0, 150, colliders), (255.19081952152942, 406.08585724377093)),
            (raycast(origin_pos, 229.49999999999997, 150, colliders), (252.48906049389996, 406.33130672156136)),
            (raycast(origin_pos, 230.49999999999997, 150, colliders), (251.78089904375534, 406.4223433764302)),
            (raycast(origin_pos, 231.00000000000003, 150, colliders), (251.4356231475129, 406.47079007342063)),
            (raycast(origin_pos, 243.5, 150, colliders), (244.04410983381075, 408.16812655533346)),
            (raycast(origin_pos, 246.0, 150, colliders), (242.73631142361893, 408.60622382134443)),
            (raycast(origin_pos, 248.0, 150, colliders), (241.70919932469442, 408.98128531258214)),
            (raycast(origin_pos, 255.0, 150, colliders), (238.17068104515434, 410.493396792956)),
            (raycast(origin_pos, 256.0, 150, colliders), (237.6641451815018, 410.73920736581806)),
            (raycast(origin_pos, 258.5, 150, colliders), (236.38709369383866, 411.3935684773817)),
            (raycast(origin_pos, 267.5, 150, colliders), (231.50188426299098, 414.39880504042355)),
            (raycast(origin_pos, 268.5, 150, colliders), (230.91183640269043, 414.821627349689)),
            (raycast(origin_pos, 269.5, 150, colliders), (230.30779084726527, 415.2693377102836)),
            (raycast(origin_pos, 271.5, 150, colliders), (229.05071507604666, 416.2517286796722)),
            (raycast(origin_pos, 272.0, 150, colliders), (228.7247573579461, 416.5181712950295)),
            (raycast(origin_pos, 274.5, 150, colliders), (227.0088097891271, 418.006675224193)),
            (raycast(origin_pos, 276.0, 150, colliders), (225.89498675611406, 419.0565920917415)),
            (raycast(origin_pos, 278.5, 150, colliders), (223.8444600453145, 421.1876795680059)),
            (raycast(origin_pos, 279.5, 150, colliders), (222.9333356428515, 422.2287210408573)),
            (raycast(origin_pos, 280.0, 150, colliders), (222.45238002897682, 422.8046799230474)),
            (raycast(origin_pos, 281.5, 150, colliders), (220.8784025603764, 424.83408378996705)),
            (raycast(origin_pos, 295.5, 150, colliders), (208.5361010285828, 425.0)),
            (raycast(origin_pos, 296.5, 150, colliders), (207.56382763759564, 425.0)),
            (raycast(origin_pos, 297.0, 150, colliders), (207.0713547727507, 425.0)),
            (raycast(origin_pos, 297.5, 150, colliders), (194.21797904079577, 448.73662272953914)),
            (raycast(origin_pos, 299.0, 150, colliders), (192.43655291206127, 447.7662523992529)),
            (raycast(origin_pos, 304.0, 150, colliders), (186.47971751923853, 444.5214721446259)),
            (raycast(origin_pos, 308.0, 150, colliders), (181.64700081180695, 441.8890167023664)),
            (raycast(origin_pos, 311.5, 150, colliders), (177.943201798039, 438.8395067796431)),
            (raycast(origin_pos, 312.0, 150, colliders), (177.55035443588338, 438.25123276186343)),
            (raycast(origin_pos, 313.0, 150, colliders), (176.79264012186346, 437.0579078763364)),
            (raycast(origin_pos, 313.5, 150, colliders), (176.42793388767086, 436.45317853941026)),
            (raycast(origin_pos, 314.0, 150, colliders), (176.0727637149346, 435.84328791213204)),
            (raycast(origin_pos, 315.0, 150, colliders), (175.39131953939545, 434.60868046060455)),
            (raycast(origin_pos, 317.0, 150, colliders), (174.14585749829885, 432.08483050611903)),
            (raycast(origin_pos, 320.5, 150, colliders), (172.3521558360356, 427.52121550829264)),
            (raycast(origin_pos, 324.0, 150, colliders), (171.06080140766542, 422.8218343438848)),
            (raycast(origin_pos, 327.0, 150, colliders), (170.35848230867478, 418.73165445857023)),
            (raycast(origin_pos, 328.5, 150, colliders), (170.1472602523408, 416.6778060896998)),
            (raycast(origin_pos, 332.0, 150, colliders), (170.01326156375347, 411.8955146011624)),
            (raycast(origin_pos, 339.5, 150, colliders), (174.56066529947435, 400.7279178853569)),
            (raycast(origin_pos, 343.0, 150, colliders), (176.82638664858283, 396.25680504554805)),
            (raycast(origin_pos, 346.5, 150, colliders), (178.84044190525304, 392.28232322247396)),
            (raycast(origin_pos, 354.5, 150, colliders), (182.75940297156964, 384.54875212415106)),
            (raycast(origin_pos, 355.0, 150, colliders), (182.9798488738923, 384.11373018081014)),
            (raycast(origin_pos, 357.5, 150, colliders), (184.04777311325034, 382.0063175546213)),
        ]
        for r in results:
            self.assertAlmostEqual(r[0][0], r[1][0])
            self.assertAlmostEqual(r[0][1], r[1][1])